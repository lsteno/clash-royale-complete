services:
  machinea:
    build:
      context: ../..
      dockerfile: docker/machineA/Dockerfile
    runtime: nvidia
    ports:
      # Bind only to localhost on the VM. Use SSH port-forward from your laptop.
      - "127.0.0.1:50051:50051"
    environment:
      - KATACR_QUIET=1
      - CR_OCR_GPU=0
      - XLA_PYTHON_CLIENT_PREALLOCATE=false
      - XLA_FLAGS=--xla_gpu_strict_conv_algorithm_picker=false
    volumes:
      # Store logs and debug dumps on the large data disk (/mnt).
      - /mnt/azureuser/logs_dreamerv3:/app/logs_dreamerv3
      - /mnt/azureuser/dumps:/app/dumps
      # Mount KataCR weights from the repo checkout.
      - ../../KataCR:/app/KataCR
    command:
      [
        "python",
        "clash-royale-mbrl/train_dreamerv3.py",
        "--logdir",
        "/app/logs_dreamerv3",
        "--rpc-host",
        "0.0.0.0",
        "--rpc-port",
        "50051",
        "--configs",
        "defaults",
        "size12m",
        "--detector-count",
        "1",
        "--disable-center-ocr",
        "--disable-card-classifier",
        "--perception-stride",
        "1",
        "--debug-dump-dir",
        "/app/dumps",
        "--debug-dump-every",
        "1",
        "--debug-dump-max",
        "50",
        "--debug-dump-annotated"
      ]

