services:
  machinea:
    build:
      context: ../..
      dockerfile: docker/machineA/Dockerfile
    runtime: nvidia
    # Run as the host user (Azure 'azureuser' is typically uid/gid 1000).
    # This prevents root-owned artifacts in mounted volumes like /mnt/azureuser/dumps.
    user: "1000:1000"
    ports:
      # Bind only to localhost on the VM. Use SSH port-forward from your laptop.
      # Override with HOST_RPC_PORT to run multiple stacks side-by-side.
      - "127.0.0.1:${HOST_RPC_PORT:-50051}:50051"
    environment:
      - KATACR_QUIET=1
      - CR_OCR_GPU=0
      - XLA_PYTHON_CLIENT_PREALLOCATE=false
      - XLA_FLAGS=--xla_gpu_strict_conv_algorithm_picker=false
    volumes:
      # Store logs and debug dumps on the large data disk (/mnt).
      # Override with HOST_LOGDIR / HOST_DUMPDIR.
      - ${HOST_LOGDIR:-/mnt/azureuser/logs_dreamerv3}:/app/logs_dreamerv3
      - ${HOST_DUMPDIR:-/mnt/azureuser/dumps}:/app/dumps
      # Mount KataCR weights from the repo checkout.
      - ../../KataCR:/app/KataCR
    command: >
      bash -lc '
        set -euo pipefail
        ARGS=(
          python clash-royale-mbrl/train_dreamerv3.py
          --logdir /app/logs_dreamerv3
          --rpc-host 0.0.0.0 --rpc-port 50051
          --configs defaults "${CR_SIZE:-size12m}"
          --detector-count "${CR_DETECTOR_COUNT:-2}"
          --perception-stride "${CR_PERCEPTION_STRIDE:-1}"
          --debug-dump-dir /app/dumps
          --debug-dump-every "${CR_DUMP_EVERY:-1}"
          --debug-dump-max "${CR_DUMP_MAX:-50}"
        )
        if [ "${CR_ENABLE_CENTER_OCR:-0}" != "1" ]; then
          ARGS+=(--disable-center-ocr)
        fi
        if [ "${CR_ENABLE_CARD_CLASSIFIER:-0}" != "1" ]; then
          ARGS+=(--disable-card-classifier)
        fi
        if [ "${CR_DUMP_ANNOTATED:-1}" = "1" ]; then
          ARGS+=(--debug-dump-annotated)
        fi
        if [ -n "${CR_EXTRA_ARGS:-}" ]; then
          # shellcheck disable=SC2206
          EXTRA=( ${CR_EXTRA_ARGS} )
          ARGS+=("${EXTRA[@]}")
        fi
        exec "${ARGS[@]}"
      '
